services:
  freeswitch:
    image: safarov/freeswitch:1.10.12
    container_name: hardline-freeswitch
    restart: unless-stopped
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
    ports:
      - "${SIP_UDP_PORT:-5060}:5060/udp"
      - "20000-20100:20000-20100/udp"
    volumes:
      - ./data/sounds:/var/lib/freeswitch/sounds/custom:ro

      - ./freeswitch/conf/autoload_configs/xml_curl.conf.xml:/usr/share/freeswitch/conf/vanilla/autoload_configs/xml_curl.conf.xml:ro
      - ./freeswitch/conf/autoload_configs/switch.conf.xml:/usr/share/freeswitch/conf/vanilla/autoload_configs/switch.conf.xml:ro
      - ./freeswitch/conf/autoload_configs/modules.conf.xml:/usr/share/freeswitch/conf/vanilla/autoload_configs/modules.conf.xml:ro
      - ./freeswitch/conf/autoload_configs/signalwire.conf.xml:/usr/share/freeswitch/conf/vanilla/autoload_configs/signalwire.conf.xml:ro
      - ./freeswitch/conf/autoload_configs/event_socket.conf.xml:/usr/share/freeswitch/conf/vanilla/autoload_configs/event_socket.conf.xml:ro
      - ./freeswitch/conf/dialplan:/usr/share/freeswitch/conf/vanilla/dialplan:ro
    networks:
      - hardline
    command: ["freeswitch", "-nonat", "-nf"]

  backend:
    build:
      context: ./backend
      target: dev
    profiles: ["dev"]
    container_name: hardline-backend-dev
    restart: unless-stopped
    depends_on:
      - freeswitch
    ports:
      - "${API_PORT:-3000}:3000"
    environment:
      - NODE_ENV=development
      - PUBLIC_HOST=${PUBLIC_HOST}
      - SERVER_PASSWORD=${SERVER_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - SQLITE_PATH=${SQLITE_PATH}
      - FS_HOST=freeswitch
      - FS_SIP_PORT=5060
      - HARDLINE_DOMAIN=hardline.local
      # если у тебя backend реально использует другой URL/параметры — вернёшь свои
    volumes:
      - ./backend:/app
      - ./data/sqlite:/data/sqlite
    networks:
      - hardline
    command: ["yarn", "run", "dev"]

  backend-prod:
    build:
      context: ./backend
      target: prod
    profiles: ["prod"]
    container_name: hardline-backend
    restart: unless-stopped
    depends_on:
      - freeswitch
    ports:
      - "${API_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PUBLIC_HOST=${PUBLIC_HOST}
      - SERVER_PASSWORD=${SERVER_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - SQLITE_PATH=${SQLITE_PATH}
      - FS_HOST=freeswitch
      - FS_SIP_PORT=5060
      - HARDLINE_DOMAIN=hardline.local
    volumes:
      - ./data/sqlite:/data/sqlite
    networks:
      - hardline

networks:
  hardline:
    driver: bridge
